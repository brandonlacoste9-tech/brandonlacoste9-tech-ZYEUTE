version: '3.8'

services:
  # Temporal for workflow orchestration
  temporal:
    image: temporalio/auto-setup:latest
    container_name: colony-temporal
    ports:
      - "7233:7233"
      - "8088:8088"
    environment:
      - DB=postgresql
      - DB_PORT=5432
      - POSTGRES_USER=temporal
      - POSTGRES_PWD=temporal
      - POSTGRES_SEEDS=temporal-postgres
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development-sql.yaml
    depends_on:
      - temporal-postgres
    networks:
      - colony-network

  temporal-postgres:
    image: postgres:15-alpine
    container_name: colony-temporal-postgres
    environment:
      - POSTGRES_USER=temporal
      - POSTGRES_PASSWORD=temporal
      - POSTGRES_DB=temporal
    volumes:
      - temporal-postgres-data:/var/lib/postgresql/data
    networks:
      - colony-network

  # LiteLLM AI Gateway
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: colony-litellm
    ports:
      - "4000:4000"
    environment:
      - MASTER_KEY=${LITELLM_MASTER_KEY:-sk-1234}
      - DATABASE_URL=postgresql://litellm:litellm@litellm-postgres:5432/litellm
    depends_on:
      - litellm-postgres
    networks:
      - colony-network

  litellm-postgres:
    image: postgres:15-alpine
    container_name: colony-litellm-postgres
    environment:
      - POSTGRES_USER=litellm
      - POSTGRES_PASSWORD=litellm
      - POSTGRES_DB=litellm
    volumes:
      - litellm-postgres-data:/var/lib/postgresql/data
    networks:
      - colony-network

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: colony-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - colony-network

  # Centrifugo for real-time streaming
  centrifugo:
    image: centrifugo/centrifugo:latest
    container_name: colony-centrifugo
    ports:
      - "8000:8000"
    volumes:
      - ./centrifugo-config.json:/centrifugo/config.json
    command: centrifugo -c /centrifugo/config.json
    networks:
      - colony-network

  # Dragonfly (Redis-compatible cache)
  dragonfly:
    image: docker.dragonflydb.io/dragonflydb/dragonfly:latest
    container_name: colony-dragonfly
    ports:
      - "6379:6379"
    volumes:
      - dragonfly-data:/data
    networks:
      - colony-network

volumes:
  temporal-postgres-data:
  litellm-postgres-data:
  qdrant-data:
  dragonfly-data:

networks:
  colony-network:
    driver: bridge

